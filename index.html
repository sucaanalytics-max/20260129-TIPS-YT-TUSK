<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Analytics - Tips & Saregama Dashboard</title>
    <meta name="description" content="YouTube Views vs Stock Price Correlation Analysis for Tips Music and Saregama India">
    <meta name="color-scheme" content="light dark">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>

    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-cyan: #06b6d4;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-amber: #f59e0b;
            --accent-pink: #ec4899;
            --gradient-primary: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --gradient-secondary: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
            --gradient-accent: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
        }

        [data-theme="light"] {
            --bg-base: #f0f2f5;
            --bg-surface: #ffffff;
            --bg-elevated: #f8f9fb;
            --bg-card: rgba(255, 255, 255, 0.9);
            --bg-glass: rgba(0, 0, 0, 0.02);
            --border: rgba(0, 0, 0, 0.1);
            --border-hover: rgba(0, 0, 0, 0.18);
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --text-muted: #9ca3af;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 30px rgba(0,0,0,0.1);
            --shadow-glow: 0 0 20px rgba(59,130,246,0.1);
            --chart-text: #4b5563;
            --chart-grid: rgba(0,0,0,0.06);
        }

        [data-theme="dark"] {
            --bg-base: #0a0f1a;
            --bg-surface: #111827;
            --bg-elevated: #1a2235;
            --bg-card: rgba(26, 34, 53, 0.85);
            --bg-glass: rgba(255, 255, 255, 0.04);
            --border: rgba(255, 255, 255, 0.08);
            --border-hover: rgba(255, 255, 255, 0.15);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.4);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.5);
            --shadow-glow: 0 0 30px rgba(59,130,246,0.15);
            --chart-text: #94a3b8;
            --chart-grid: rgba(255,255,255,0.06);
        }

        html { scroll-behavior: smooth; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-base);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background:
                radial-gradient(ellipse 80% 50% at 20% 20%, rgba(59,130,246,0.08) 0%, transparent 60%),
                radial-gradient(ellipse 60% 40% at 80% 80%, rgba(139,92,246,0.06) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
        }

        .app { position: relative; z-index: 1; }

        /* Header */
        .header {
            padding: 32px 24px 24px;
            text-align: center;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, rgba(59,130,246,0.06) 0%, transparent 100%);
        }

        .header-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 14px;
            background: rgba(59,130,246,0.12);
            border: 1px solid rgba(59,130,246,0.25);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent-blue);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 14px;
        }

        .header-badge .pulse {
            width: 7px; height: 7px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(16,185,129,0.4); }
            50% { opacity: 0.7; box-shadow: 0 0 0 6px rgba(16,185,129,0); }
        }

        .header h1 {
            font-size: clamp(1.5rem, 4vw, 2.25rem);
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
            margin-bottom: 6px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-surface);
        }

        .tab-button {
            padding: 10px 28px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.25s ease;
            font-family: inherit;
        }

        .tab-button:hover {
            background: var(--bg-glass);
            border-color: var(--border-hover);
            color: var(--text-primary);
        }

        .tab-button.active {
            background: var(--gradient-primary);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 16px rgba(59,130,246,0.35);
        }

        /* Content container */
        .content { max-width: 1440px; margin: 0 auto; padding: 0 20px; }

        /* Controls */
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            padding: 20px 0;
        }

        .controls label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .controls select,
        .controls input[type="date"] {
            padding: 9px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            background: var(--bg-elevated);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .controls select:focus,
        .controls input[type="date"]:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
        }

        .btn {
            padding: 9px 18px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s;
            font-family: inherit;
            box-shadow: 0 2px 10px rgba(59,130,246,0.3);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(59,130,246,0.45);
        }

        .btn:active { transform: translateY(0); }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            box-shadow: none;
        }

        .btn-outline:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
            box-shadow: none;
        }

        .btn-outline.active {
            background: rgba(59,130,246,0.12);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        /* Data Status Banner */
        .data-status {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            padding: 14px 20px;
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            font-size: 0.8rem;
        }

        .data-status-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
        }

        .data-status-item .dot {
            width: 8px; height: 8px;
            border-radius: 50%;
        }

        .dot-green { background: var(--accent-green); }
        .dot-amber { background: var(--accent-amber); }
        .dot-red { background: var(--accent-red); }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            padding: 22px;
            border-radius: var(--radius-md);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
        }

        .stat-card:nth-child(1)::before { background: var(--gradient-primary); }
        .stat-card:nth-child(2)::before { background: var(--gradient-secondary); }
        .stat-card:nth-child(3)::before { background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-cyan) 100%); }
        .stat-card:nth-child(4)::before { background: var(--gradient-accent); }
        .stat-card:nth-child(5)::before { background: linear-gradient(135deg, var(--accent-amber) 0%, var(--accent-pink) 100%); }
        .stat-card:nth-child(6)::before { background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-green) 100%); }

        .stat-card:hover {
            border-color: var(--border-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .stat-card h3 {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -0.5px;
            margin-bottom: 6px;
            font-variant-numeric: tabular-nums;
        }

        .stat-card .subtitle {
            font-size: 0.78rem;
            color: var(--text-muted);
        }

        .stat-card .subtitle.positive { color: var(--accent-green); }
        .stat-card .subtitle.negative { color: var(--accent-red); }

        /* Section headings */
        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title .icon {
            width: 32px; height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            font-size: 1rem;
        }

        /* Period Summary */
        .period-summary {
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 24px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .period-summary::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: var(--gradient-secondary);
        }

        .period-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .period-summary-header .section-title { margin-bottom: 0; }

        .period-range {
            padding: 5px 14px;
            background: rgba(6,182,212,0.1);
            border: 1px solid rgba(6,182,212,0.25);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent-cyan);
            letter-spacing: 0.3px;
        }

        .period-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .period-stat {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 14px 16px;
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
        }

        .period-stat-label {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        .period-stat-value {
            font-size: 1.35rem;
            font-weight: 800;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
            letter-spacing: -0.3px;
        }

        .period-stat-sub {
            font-size: 0.72rem;
            color: var(--text-muted);
        }

        .period-stat-sub.positive { color: var(--accent-green); }
        .period-stat-sub.negative { color: var(--accent-red); }

        [data-theme="light"] .period-summary { backdrop-filter: none; box-shadow: var(--shadow-sm); }

        @media (max-width: 768px) {
            .period-summary { padding: 16px; }
            .period-summary-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .period-stat { padding: 10px 12px; }
            .period-stat-value { font-size: 1.1rem; }
        }

        @media (max-width: 480px) {
            .period-summary-grid { grid-template-columns: 1fr; }
        }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            padding: 22px;
            border-radius: var(--radius-md);
            transition: border-color 0.3s;
        }

        .chart-card:hover { border-color: var(--border-hover); }

        .chart-card.full-width { grid-column: 1 / -1; }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 14px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .chart-header h3 {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .chart-header p {
            font-size: 0.78rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .chart-controls {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .chart-btn {
            padding: 5px 12px;
            border: 1px solid var(--border);
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            transition: all 0.2s;
            font-family: inherit;
        }

        .chart-btn:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .chart-btn.active {
            background: rgba(59,130,246,0.12);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        /* Table */
        .table-section {
            margin-bottom: 24px;
        }

        .table-card {
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .table-wrapper { overflow-x: auto; }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.82rem;
            font-variant-numeric: tabular-nums;
        }

        thead { background: rgba(255,255,255,0.03); }

        th {
            padding: 12px 14px;
            text-align: left;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.6px;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        td {
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
        }

        tbody tr { transition: background 0.15s; }
        tbody tr:hover { background: rgba(59,130,246,0.04); }
        tbody tr:last-child td { border-bottom: none; }

        .positive { color: var(--accent-green); font-weight: 600; }
        .negative { color: var(--accent-red); font-weight: 600; }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 20px;
            border-top: 1px solid var(--border);
        }

        .pagination button {
            padding: 8px 16px;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: all 0.2s;
            font-family: inherit;
        }

        .pagination button:hover:not(:disabled) {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .pagination button:disabled {
            opacity: 0.35;
            cursor: not-allowed;
        }

        .pagination span {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 28px 20px;
            border-top: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: 12px;
        }

        .footer p { margin: 3px 0; }

        /* Loading */
        .loading {
            text-align: center;
            padding: 50px;
            color: var(--text-muted);
        }

        .loading-spinner {
            width: 32px; height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Utility */
        .hidden { display: none !important; }

        /* Responsive */
        @media (max-width: 1024px) {
            .charts-grid { grid-template-columns: 1fr; }
            .chart-card.full-width { grid-column: 1; }
        }

        @media (max-width: 768px) {
            .content { padding: 0 12px; }
            .header { padding: 24px 16px 20px; }
            .tabs { padding: 12px 16px; }
            .tab-button { padding: 8px 18px; font-size: 0.85rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .stat-card { padding: 16px; }
            .stat-card .value { font-size: 1.3rem; }
            .controls { flex-direction: column; align-items: stretch; }
            .controls select, .controls input, .controls button { width: 100%; }
            table { font-size: 0.75rem; }
            th, td { padding: 8px 10px; }
        }

        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 1.3rem; }
        }

        /* Accessibility: focus styles */
        :focus-visible {
            outline: 2px solid var(--accent-blue);
            outline-offset: 2px;
        }

        /* Skip to main content (screen readers) */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--accent-blue);
            color: white;
            padding: 8px 16px;
            z-index: 100;
            font-size: 0.85rem;
        }

        .skip-link:focus { top: 0; }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 50;
            width: 40px; height: 40px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: all 0.25s;
            box-shadow: var(--shadow-sm);
        }

        .theme-toggle:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
            transform: scale(1.08);
        }

        /* Light theme background override */
        [data-theme="light"] body::before {
            background:
                radial-gradient(ellipse 80% 50% at 20% 20%, rgba(59,130,246,0.04) 0%, transparent 60%),
                radial-gradient(ellipse 60% 40% at 80% 80%, rgba(139,92,246,0.03) 0%, transparent 60%);
        }

        [data-theme="light"] .stat-card { backdrop-filter: none; box-shadow: var(--shadow-sm); }
        [data-theme="light"] .chart-card { backdrop-filter: none; box-shadow: var(--shadow-sm); }
        [data-theme="light"] .table-card { backdrop-filter: none; box-shadow: var(--shadow-sm); }
        [data-theme="light"] .tab-button.active { box-shadow: 0 4px 12px rgba(59,130,246,0.25); }
        [data-theme="light"] tbody tr:hover { background: rgba(59,130,246,0.03); }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle dark/light mode" title="Toggle theme" id="themeToggle">&#9790;</button>

    <div class="app">
        <!-- Header -->
        <div class="header">
            <div class="header-badge">
                <span class="pulse"></span>
                Live Analytics
            </div>
            <h1>Music Stock Analytics Dashboard</h1>
            <p>YouTube Channel Metrics vs NSE Stock Price Correlation</p>
        </div>

        <!-- Tab Navigation -->
        <nav class="tabs" role="tablist" aria-label="Company selection">
            <button class="tab-button active" role="tab" aria-selected="true" onclick="switchCompany('tips', this)">
                Tips Music
            </button>
            <button class="tab-button" role="tab" aria-selected="false" onclick="switchCompany('saregama', this)">
                Saregama India
            </button>
        </nav>

        <!-- Main Content -->
        <main id="main-content" class="content">
            <!-- Controls -->
            <div class="controls">
                <label for="timePeriod">Period:</label>
                <select id="timePeriod" onchange="handleTimePeriodChange()">
                    <option value="30">Last 30 Days</option>
                    <option value="90" selected>Last 90 Days</option>
                    <option value="180">Last 6 Months</option>
                    <option value="365">Last 1 Year</option>
                    <option value="all">All Time</option>
                    <option value="custom">Custom Range</option>
                </select>

                <input type="date" id="startDate" class="hidden" aria-label="Start date">
                <input type="date" id="endDate" class="hidden" aria-label="End date">

                <button class="btn" onclick="fetchData()" aria-label="Refresh data">Refresh</button>
                <button class="btn btn-outline" id="exportBtn" onclick="exportCSV()" aria-label="Export data as CSV">Export CSV</button>
            </div>

            <!-- Data Status -->
            <div class="data-status" id="dataStatus" role="status" aria-live="polite">
                <div class="data-status-item">
                    <span class="dot dot-green" id="ytStatusDot"></span>
                    <span>YouTube: <strong id="ytRecordCount">--</strong> records</span>
                </div>
                <div class="data-status-item">
                    <span class="dot dot-green" id="stockStatusDot"></span>
                    <span>Stock: <strong id="stockRecordCount">--</strong> records</span>
                </div>
                <div class="data-status-item">
                    <span>Latest YT: <strong id="latestYTDate">--</strong></span>
                </div>
                <div class="data-status-item">
                    <span>Latest Stock: <strong id="latestStockDate">--</strong></span>
                </div>
                <div class="data-status-item">
                    <span>Correlation Days: <strong id="correlationDays">--</strong></span>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Subscribers</h3>
                    <div class="value" id="totalSubs">--</div>
                    <div class="subtitle" id="subsChange">Loading...</div>
                </div>
                <div class="stat-card">
                    <h3>Total Views</h3>
                    <div class="value" id="totalViews">--</div>
                    <div class="subtitle" id="viewsGrowth">Loading...</div>
                </div>
                <div class="stat-card">
                    <h3>Daily Views (Latest)</h3>
                    <div class="value" id="dailyViews">--</div>
                    <div class="subtitle" id="dailyViewsChange">Loading...</div>
                </div>
                <div class="stat-card">
                    <h3>Stock Price</h3>
                    <div class="value" id="stockPrice">--</div>
                    <div class="subtitle" id="stockChange">Loading...</div>
                </div>
                <div class="stat-card">
                    <h3>Stock Volume</h3>
                    <div class="value" id="stockVolume">--</div>
                    <div class="subtitle" id="volumeChange">Loading...</div>
                </div>
                <div class="stat-card">
                    <h3>Avg Daily Views (30d)</h3>
                    <div class="value" id="avgDailyViews">--</div>
                    <div class="subtitle" id="avgViewsTrend">Loading...</div>
                </div>
            </div>

            <!-- Period Summary - reacts to date range selection -->
            <div class="period-summary" id="periodSummary">
                <div class="period-summary-header">
                    <h2 class="section-title">Period Summary</h2>
                    <span class="period-range" id="periodRangeLabel">Last 90 Days</span>
                </div>
                <div class="period-summary-grid">
                    <div class="period-stat">
                        <span class="period-stat-label">Total Views in Period</span>
                        <span class="period-stat-value" id="periodTotalViews">--</span>
                    </div>
                    <div class="period-stat">
                        <span class="period-stat-label">Avg Daily Views</span>
                        <span class="period-stat-value" id="periodAvgViews">--</span>
                    </div>
                    <div class="period-stat">
                        <span class="period-stat-label">Peak Daily Views</span>
                        <span class="period-stat-value" id="periodPeakViews">--</span>
                        <span class="period-stat-sub" id="periodPeakDate"></span>
                    </div>
                    <div class="period-stat">
                        <span class="period-stat-label">Lowest Daily Views</span>
                        <span class="period-stat-value" id="periodMinViews">--</span>
                        <span class="period-stat-sub" id="periodMinDate"></span>
                    </div>
                    <div class="period-stat">
                        <span class="period-stat-label">Subscriber Growth</span>
                        <span class="period-stat-value" id="periodSubGrowth">--</span>
                        <span class="period-stat-sub" id="periodSubGrowthPct"></span>
                    </div>
                    <div class="period-stat">
                        <span class="period-stat-label">Days of Data</span>
                        <span class="period-stat-value" id="periodDays">--</span>
                        <span class="period-stat-sub" id="periodDateRange"></span>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <!-- Daily Views Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <h3 id="viewsChartTitle">Daily Views - Tips Music</h3>
                            <p>YouTube channel daily view count</p>
                        </div>
                        <div class="chart-controls">
                            <button class="chart-btn active" onclick="toggleScale('views', 'linear', this)">Linear</button>
                            <button class="chart-btn" onclick="toggleScale('views', 'logarithmic', this)">Log</button>
                            <button class="chart-btn" onclick="toggleMA('views', this)">MA</button>
                        </div>
                    </div>
                    <canvas id="viewsChart"></canvas>
                </div>

                <!-- Stock Price Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <h3 id="stockChartTitle">Stock Price - NSE: TIPSMUSIC</h3>
                            <p>Daily closing price with OHLC data</p>
                        </div>
                        <div class="chart-controls">
                            <button class="chart-btn active" onclick="toggleScale('stock', 'linear', this)">Linear</button>
                            <button class="chart-btn" onclick="toggleScale('stock', 'logarithmic', this)">Log</button>
                            <button class="chart-btn" onclick="toggleMA('stock', this)">MA</button>
                        </div>
                    </div>
                    <canvas id="stockChart"></canvas>
                </div>

                <!-- Subscriber Growth Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <h3>Subscriber Growth</h3>
                            <p>Total subscriber count over time</p>
                        </div>
                    </div>
                    <canvas id="subscriberChart"></canvas>
                </div>

                <!-- Monthly Views Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <h3>Monthly Views Aggregation</h3>
                            <p>Total views grouped by month</p>
                        </div>
                    </div>
                    <canvas id="monthlyChart"></canvas>
                </div>

                <!-- Correlation Chart (full width) -->
                <div class="chart-card full-width">
                    <div class="chart-header">
                        <div>
                            <h3>Views vs Stock Price Correlation (Dual-Axis)</h3>
                            <p>Overlaid comparison of YouTube performance and stock movement</p>
                        </div>
                        <div class="chart-controls">
                            <button class="chart-btn active" onclick="toggleDualAxis('raw', this)">Raw</button>
                            <button class="chart-btn" onclick="toggleDualAxis('ma7', this)">7d MA</button>
                            <button class="chart-btn" onclick="toggleDualAxis('ma30', this)">30d MA</button>
                            <button class="chart-btn" onclick="toggleDualAxis('ma45', this)">45d MA</button>
                            <button class="chart-btn" onclick="toggleDualAxis('both', this)">Smoothed Both</button>
                        </div>
                    </div>
                    <canvas id="correlationChart"></canvas>
                </div>

                <!-- Stock Volume Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <h3>Trading Volume</h3>
                            <p>Daily stock trading volume</p>
                        </div>
                    </div>
                    <canvas id="volumeChart"></canvas>
                </div>

                <!-- Views Distribution Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <h3>Daily Views Distribution</h3>
                            <p>Weekday pattern analysis</p>
                        </div>
                    </div>
                    <canvas id="distributionChart"></canvas>
                </div>
            </div>

            <!-- Data Table -->
            <div class="table-section">
                <h2 class="section-title">Daily Channel & Stock Metrics</h2>
                <div class="table-card">
                    <div class="table-wrapper">
                        <table id="dataTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Daily Views</th>
                                    <th>Views Change</th>
                                    <th>% Change</th>
                                    <th>Subscribers</th>
                                    <th>Sub Change</th>
                                    <th>Total Views</th>
                                    <th>Stock Close</th>
                                    <th>Stock Open</th>
                                    <th>Stock High</th>
                                    <th>Stock Low</th>
                                    <th>Volume</th>
                                    <th>Stock Change</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <tr>
                                    <td colspan="13" class="loading">
                                        <div class="loading-spinner"></div>
                                        Loading data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="pagination">
                        <button onclick="previousPage()" id="prevBtn" disabled aria-label="Previous page">Prev</button>
                        <span id="pageInfo">Showing 0-0 of 0 records</span>
                        <button onclick="nextPage()" id="nextBtn" aria-label="Next page">Next</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <div class="footer">
            <p>Last updated: <span id="lastUpdated">--</span></p>
            <p>Data: Supabase PostgreSQL | Stock: <span id="footerStock">NSE TIPSMUSIC</span> via Yahoo Finance</p>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const SUPABASE_URL = 'https://bfafqccvzboyfjewzvhk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJmYWZxY2N2emJveWZqZXd6dmhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2OTM4NzUsImV4cCI6MjA4MzI2OTg3NX0.OoyXHxHxAvSiE28NG3fz-S5QXcKz6OwspLrb9mSGH2Q';

        let currentCompany = 'tips';

        const COMPANY_CONFIG = {
            tips: {
                name: 'Tips Music',
                youtubeTable: 'tips_youtube_data',
                stockSymbol: 'TIPSMUSIC',
                stockName: 'NSE: TIPSMUSIC',
                channelUrl: 'https://www.youtube.com/@tipsofficial'
            },
            saregama: {
                name: 'Saregama Music',
                youtubeTable: 'saregama_youtube_data',
                stockSymbol: 'SAREGAMA',
                stockName: 'NSE: SAREGAMA',
                channelUrl: 'https://www.youtube.com/@saregamamusic'
            }
        };

        // ==========================================
        // STATE
        // ==========================================
        let allYoutubeData = [];
        let allStockData = [];
        let currentPage = 1;
        const rowsPerPage = 50;
        let charts = {};
        let chartStates = {
            views: { scale: 'linear', showMA: false },
            stock: { scale: 'linear', showMA: false },
            dualAxis: 'raw'
        };

        // ==========================================
        // THEME SYSTEM
        // ==========================================
        function initTheme() {
            const saved = localStorage.getItem('theme');
            if (saved) {
                document.documentElement.setAttribute('data-theme', saved);
            } else if (window.matchMedia('(prefers-color-scheme: light)').matches) {
                document.documentElement.setAttribute('data-theme', 'light');
            }
            updateThemeIcon();
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            updateThemeIcon();
            applyChartTheme();
            renderAllCharts();
        }

        function updateThemeIcon() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            document.getElementById('themeToggle').innerHTML = isDark ? '&#9790;' : '&#9728;';
        }

        function applyChartTheme() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            Chart.defaults.color = isDark ? '#94a3b8' : '#4b5563';
            Chart.defaults.borderColor = isDark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.06)';
        }

        // Init theme immediately
        initTheme();

        // Listen for OS theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            if (!localStorage.getItem('theme')) {
                document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
                updateThemeIcon();
                applyChartTheme();
                renderAllCharts();
            }
        });

        // ==========================================
        // CHART.JS DEFAULTS
        // ==========================================
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.font.size = 11;
        applyChartTheme();

        // ==========================================
        // UTILITIES
        // ==========================================
        function formatNumber(num) {
            if (num == null) return '--';
            if (Math.abs(num) >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (Math.abs(num) >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (Math.abs(num) >= 1e3) return (num / 1e3).toFixed(1) + 'K';
            return num.toLocaleString('en-IN');
        }

        function formatNumberFull(num) {
            if (num == null) return '--';
            return num.toLocaleString('en-IN');
        }

        function formatCurrency(num) {
            if (num == null) return '--';
            return '\u20B9' + parseFloat(num).toFixed(2);
        }

        function formatPercentage(num) {
            if (num == null) return '--';
            const sign = num > 0 ? '+' : '';
            return sign + parseFloat(num).toFixed(2) + '%';
        }

        function calculatePercentageChange(current, previous) {
            if (!previous || previous === 0) return 0;
            return ((current - previous) / previous) * 100;
        }

        function calculateMovingAverage(data, period) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    result.push(null);
                } else {
                    let sum = 0;
                    for (let j = 0; j < period; j++) sum += data[i - j];
                    result.push(sum / period);
                }
            }
            return result;
        }

        function filterDataByTimePeriod(data) {
            const period = document.getElementById('timePeriod').value;

            if (period === 'all') return data;

            if (period === 'custom') {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                if (startDate && endDate) {
                    return data.filter(item => item.date >= startDate && item.date <= endDate);
                }
                return data;
            }

            const days = parseInt(period);
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - days);
            const cutoffStr = cutoffDate.toISOString().split('T')[0];
            return data.filter(item => item.date >= cutoffStr);
        }

        // ==========================================
        // DATA FETCHING
        // ==========================================
        async function fetchYouTubeData() {
            const config = COMPANY_CONFIG[currentCompany];
            try {
                const response = await axios.get(
                    `${SUPABASE_URL}/rest/v1/${config.youtubeTable}`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        },
                        params: { select: '*', order: 'date.desc' }
                    }
                );
                return response.data || [];
            } catch (error) {
                console.error('Error fetching YouTube data:', error);
                return [];
            }
        }

        async function fetchStockPrices() {
            const config = COMPANY_CONFIG[currentCompany];
            try {
                const response = await axios.get(
                    `${SUPABASE_URL}/rest/v1/stock_prices`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        },
                        params: {
                            select: '*',
                            symbol: `eq.${config.stockSymbol}`,
                            order: 'date.desc'
                        }
                    }
                );
                return response.data || [];
            } catch (error) {
                console.error('Error fetching stock data:', error);
                return [];
            }
        }

        async function fetchData() {
            console.log('Fetching data for:', currentCompany);

            const [youtubeData, stockData] = await Promise.all([
                fetchYouTubeData(),
                fetchStockPrices()
            ]);

            allYoutubeData = youtubeData;
            allStockData = stockData;

            updateDataStatus();
            updateStats();
            updatePeriodSummary();
            renderAllCharts();
            renderTable();
            updateLastUpdated();
        }

        // ==========================================
        // DATA STATUS
        // ==========================================
        function updateDataStatus() {
            document.getElementById('ytRecordCount').textContent = allYoutubeData.length;
            document.getElementById('stockRecordCount').textContent = allStockData.length;

            const ytDot = document.getElementById('ytStatusDot');
            const stockDot = document.getElementById('stockStatusDot');

            if (allYoutubeData.length > 0) {
                document.getElementById('latestYTDate').textContent = allYoutubeData[0].date;
                const daysSinceYT = Math.floor((new Date() - new Date(allYoutubeData[0].date)) / 86400000);
                ytDot.className = daysSinceYT <= 2 ? 'dot dot-green' : daysSinceYT <= 5 ? 'dot dot-amber' : 'dot dot-red';
            } else {
                document.getElementById('latestYTDate').textContent = 'No data';
                ytDot.className = 'dot dot-red';
            }

            if (allStockData.length > 0) {
                document.getElementById('latestStockDate').textContent = allStockData[0].date;
                const daysSinceStock = Math.floor((new Date() - new Date(allStockData[0].date)) / 86400000);
                stockDot.className = daysSinceStock <= 3 ? 'dot dot-green' : daysSinceStock <= 7 ? 'dot dot-amber' : 'dot dot-red';
            } else {
                document.getElementById('latestStockDate').textContent = 'No data';
                stockDot.className = 'dot dot-red';
            }

            // Count correlation days (days with both data)
            const ytDates = new Set(allYoutubeData.map(d => d.date));
            const corrDays = allStockData.filter(s => ytDates.has(s.date)).length;
            document.getElementById('correlationDays').textContent = corrDays;
        }

        // ==========================================
        // STATS
        // ==========================================
        function updateStats() {
            if (allYoutubeData.length > 0) {
                const latest = allYoutubeData[0];
                const prev = allYoutubeData.length > 1 ? allYoutubeData[1] : null;

                document.getElementById('totalSubs').textContent = formatNumber(latest.subscribers);
                document.getElementById('totalViews').textContent = formatNumber(latest.total_views);
                document.getElementById('dailyViews').textContent = formatNumber(latest.daily_views);

                if (prev) {
                    const subChange = latest.subscribers - prev.subscribers;
                    const el = document.getElementById('subsChange');
                    el.textContent = subChange > 0 ? `+${formatNumberFull(subChange)} today` : 'No change';
                    el.className = subChange > 0 ? 'subtitle positive' : 'subtitle';

                    const viewChange = calculatePercentageChange(latest.daily_views, prev.daily_views);
                    const dvEl = document.getElementById('dailyViewsChange');
                    dvEl.textContent = formatPercentage(viewChange) + ' vs prev day';
                    dvEl.className = viewChange >= 0 ? 'subtitle positive' : 'subtitle negative';

                    const totalViewsGrowth = latest.total_views - prev.total_views;
                    const vgEl = document.getElementById('viewsGrowth');
                    vgEl.textContent = `+${formatNumberFull(totalViewsGrowth)} today`;
                    vgEl.className = 'subtitle positive';
                }

                // 30-day average
                const last30 = allYoutubeData.slice(0, 30);
                if (last30.length > 0) {
                    const avg = last30.reduce((s, d) => s + (d.daily_views || 0), 0) / last30.length;
                    document.getElementById('avgDailyViews').textContent = formatNumber(Math.round(avg));

                    // Compare to previous 30 days
                    const prev30 = allYoutubeData.slice(30, 60);
                    if (prev30.length > 0) {
                        const prevAvg = prev30.reduce((s, d) => s + (d.daily_views || 0), 0) / prev30.length;
                        const trend = calculatePercentageChange(avg, prevAvg);
                        const tEl = document.getElementById('avgViewsTrend');
                        tEl.textContent = formatPercentage(trend) + ' vs prev 30d';
                        tEl.className = trend >= 0 ? 'subtitle positive' : 'subtitle negative';
                    }
                }
            }

            if (allStockData.length > 0) {
                const latestStock = allStockData[0];
                const prevStock = allStockData.length > 1 ? allStockData[1] : null;

                document.getElementById('stockPrice').textContent = formatCurrency(latestStock.close);
                document.getElementById('stockVolume').textContent = formatNumber(latestStock.volume);

                if (prevStock) {
                    const change = latestStock.close - prevStock.close;
                    const changePercent = calculatePercentageChange(latestStock.close, prevStock.close);
                    const scEl = document.getElementById('stockChange');
                    scEl.textContent = `${change > 0 ? '+' : ''}${formatCurrency(change)} (${formatPercentage(changePercent)})`;
                    scEl.className = change >= 0 ? 'subtitle positive' : 'subtitle negative';

                    const volChange = calculatePercentageChange(latestStock.volume, prevStock.volume);
                    const vcEl = document.getElementById('volumeChange');
                    vcEl.textContent = formatPercentage(volChange) + ' vs prev day';
                    vcEl.className = volChange >= 0 ? 'subtitle positive' : 'subtitle negative';
                }
            }
        }

        // ==========================================
        // PERIOD SUMMARY - total views for selected date range
        // ==========================================
        function updatePeriodSummary() {
            const filtered = filterDataByTimePeriod(allYoutubeData);
            const period = document.getElementById('timePeriod').value;

            // Period label
            const labels = { '30': 'Last 30 Days', '90': 'Last 90 Days', '180': 'Last 6 Months', '365': 'Last 1 Year', 'all': 'All Time', 'custom': 'Custom Range' };
            document.getElementById('periodRangeLabel').textContent = labels[period] || period;

            if (!filtered.length) {
                ['periodTotalViews','periodAvgViews','periodPeakViews','periodMinViews','periodSubGrowth','periodDays'].forEach(id => {
                    document.getElementById(id).textContent = '--';
                });
                return;
            }

            // Total views in period (sum of daily_views)
            const totalViews = filtered.reduce((sum, d) => sum + (d.daily_views || 0), 0);
            document.getElementById('periodTotalViews').textContent = formatNumber(totalViews);

            // Average daily views
            const avgViews = Math.round(totalViews / filtered.length);
            document.getElementById('periodAvgViews').textContent = formatNumber(avgViews);

            // Peak day
            let peak = filtered[0], min = filtered[0];
            filtered.forEach(d => {
                if ((d.daily_views || 0) > (peak.daily_views || 0)) peak = d;
                if ((d.daily_views || 0) < (min.daily_views || 0)) min = d;
            });

            document.getElementById('periodPeakViews').textContent = formatNumber(peak.daily_views);
            document.getElementById('periodPeakDate').textContent = peak.date;

            document.getElementById('periodMinViews').textContent = formatNumber(min.daily_views);
            document.getElementById('periodMinDate').textContent = min.date;

            // Subscriber growth across the period
            // Data is sorted desc, so last element = oldest in period, first = newest
            const newest = filtered[0];
            const oldest = filtered[filtered.length - 1];
            if (newest.subscribers && oldest.subscribers) {
                const growth = newest.subscribers - oldest.subscribers;
                const growthPct = calculatePercentageChange(newest.subscribers, oldest.subscribers);
                document.getElementById('periodSubGrowth').textContent = (growth > 0 ? '+' : '') + formatNumber(growth);
                const pctEl = document.getElementById('periodSubGrowthPct');
                pctEl.textContent = formatPercentage(growthPct);
                pctEl.className = growth >= 0 ? 'period-stat-sub positive' : 'period-stat-sub negative';
            } else {
                document.getElementById('periodSubGrowth').textContent = '--';
                document.getElementById('periodSubGrowthPct').textContent = '';
            }

            // Days count and range
            document.getElementById('periodDays').textContent = filtered.length;
            document.getElementById('periodDateRange').textContent = `${oldest.date} to ${newest.date}`;
        }

        // ==========================================
        // TAB SWITCHING
        // ==========================================
        function switchCompany(company, btn) {
            currentCompany = company;
            const config = COMPANY_CONFIG[company];

            document.querySelectorAll('.tab-button').forEach(b => {
                b.classList.remove('active');
                b.setAttribute('aria-selected', 'false');
            });
            btn.classList.add('active');
            btn.setAttribute('aria-selected', 'true');

            document.getElementById('viewsChartTitle').textContent = `Daily Views - ${config.name}`;
            document.getElementById('stockChartTitle').textContent = `Stock Price - ${config.stockName}`;
            document.getElementById('footerStock').textContent = config.stockName;

            currentPage = 1;
            fetchData();
        }

        function handleTimePeriodChange() {
            const period = document.getElementById('timePeriod').value;
            if (period === 'custom') {
                document.getElementById('startDate').classList.remove('hidden');
                document.getElementById('endDate').classList.remove('hidden');
            } else {
                document.getElementById('startDate').classList.add('hidden');
                document.getElementById('endDate').classList.add('hidden');
                updatePeriodSummary();
                renderAllCharts();
                renderTable();
            }
        }

        function updateLastUpdated() {
            document.getElementById('lastUpdated').textContent = new Date().toLocaleString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });
        }

        // ==========================================
        // CHART COLOR PALETTES
        // ==========================================
        const COLORS = {
            blue: { line: '#3b82f6', fill: 'rgba(59,130,246,0.08)' },
            purple: { line: '#8b5cf6', fill: 'rgba(139,92,246,0.08)' },
            cyan: { line: '#06b6d4', fill: 'rgba(6,182,212,0.08)' },
            green: { line: '#10b981', fill: 'rgba(16,185,129,0.08)' },
            amber: { line: '#f59e0b', fill: 'rgba(245,158,11,0.08)' },
            red: { line: '#ef4444', fill: 'rgba(239,68,68,0.08)' },
            pink: { line: '#ec4899', fill: 'rgba(236,72,153,0.08)' }
        };

        // ==========================================
        // CHART RENDERING
        // ==========================================
        function renderAllCharts() {
            const filteredYT = filterDataByTimePeriod([...allYoutubeData].reverse());
            const filteredStock = filterDataByTimePeriod([...allStockData].reverse());

            renderViewsChart(filteredYT);
            renderStockChart(filteredStock);
            renderSubscriberChart(filteredYT);
            renderMonthlyChart(filteredYT);
            renderCorrelationChart(filteredYT, filteredStock);
            renderVolumeChart(filteredStock);
            renderDistributionChart(filteredYT);
        }

        function destroyChart(name) {
            if (charts[name]) { charts[name].destroy(); charts[name] = null; }
        }

        function baseChartOptions(yCallback) {
            return {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: true, position: 'top', labels: { boxWidth: 12, padding: 12 } }
                },
                scales: {
                    x: { ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 10, font: { size: 10 } }, grid: { display: false } },
                    y: { ticks: { callback: yCallback || (v => formatNumber(v)), font: { size: 10 } }, grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--chart-grid').trim() || 'rgba(255,255,255,0.04)' } }
                }
            };
        }

        function renderViewsChart(data) {
            destroyChart('views');
            if (!data.length) return;

            const ctx = document.getElementById('viewsChart').getContext('2d');
            const dates = data.map(d => d.date);
            const views = data.map(d => d.daily_views);

            const datasets = [{
                label: 'Daily Views',
                data: views,
                borderColor: COLORS.blue.line,
                backgroundColor: COLORS.blue.fill,
                borderWidth: 1.5, fill: true, tension: 0.2, pointRadius: 0, pointHoverRadius: 4
            }];

            if (chartStates.views.showMA) {
                datasets.push(
                    { label: '7d MA', data: calculateMovingAverage(views, 7), borderColor: COLORS.green.line, borderWidth: 1.5, fill: false, tension: 0.3, pointRadius: 0 },
                    { label: '30d MA', data: calculateMovingAverage(views, 30), borderColor: COLORS.amber.line, borderWidth: 1.5, fill: false, tension: 0.3, pointRadius: 0 },
                    { label: '45d MA', data: calculateMovingAverage(views, 45), borderColor: COLORS.red.line, borderWidth: 1.5, fill: false, tension: 0.3, pointRadius: 0 }
                );
            }

            const opts = baseChartOptions();
            opts.scales.y.type = chartStates.views.scale;
            opts.scales.y.beginAtZero = chartStates.views.scale === 'linear';

            charts.views = new Chart(ctx, { type: 'line', data: { labels: dates, datasets }, options: opts });
        }

        function renderStockChart(data) {
            destroyChart('stock');
            if (!data.length) return;

            const ctx = document.getElementById('stockChart').getContext('2d');
            const dates = data.map(d => d.date);
            const prices = data.map(d => parseFloat(d.close));

            const datasets = [{
                label: 'Close Price',
                data: prices,
                borderColor: COLORS.purple.line,
                backgroundColor: COLORS.purple.fill,
                borderWidth: 1.5, fill: true, tension: 0.2, pointRadius: 0, pointHoverRadius: 4
            }];

            // Add high/low range if available
            const highs = data.map(d => d.high ? parseFloat(d.high) : null);
            const lows = data.map(d => d.low ? parseFloat(d.low) : null);
            if (highs.some(h => h != null)) {
                datasets.push({
                    label: 'High',
                    data: highs,
                    borderColor: 'rgba(16,185,129,0.4)',
                    borderWidth: 1, borderDash: [4, 4], fill: false, tension: 0.2, pointRadius: 0
                });
                datasets.push({
                    label: 'Low',
                    data: lows,
                    borderColor: 'rgba(239,68,68,0.4)',
                    borderWidth: 1, borderDash: [4, 4], fill: false, tension: 0.2, pointRadius: 0
                });
            }

            if (chartStates.stock.showMA) {
                datasets.push(
                    { label: '7d MA', data: calculateMovingAverage(prices, 7), borderColor: COLORS.green.line, borderWidth: 1.5, fill: false, tension: 0.3, pointRadius: 0 },
                    { label: '30d MA', data: calculateMovingAverage(prices, 30), borderColor: COLORS.amber.line, borderWidth: 1.5, fill: false, tension: 0.3, pointRadius: 0 },
                    { label: '45d MA', data: calculateMovingAverage(prices, 45), borderColor: COLORS.red.line, borderWidth: 1.5, fill: false, tension: 0.3, pointRadius: 0 }
                );
            }

            const opts = baseChartOptions(v => '\u20B9' + v.toFixed(0));
            opts.scales.y.type = chartStates.stock.scale;
            opts.scales.y.beginAtZero = false;
            opts.plugins.tooltip = {
                callbacks: {
                    label: ctx => {
                        const d = data[ctx.dataIndex];
                        if (ctx.dataset.label === 'Close Price' && d) {
                            return [
                                `Close: \u20B9${parseFloat(d.close).toFixed(2)}`,
                                d.open ? `Open: \u20B9${parseFloat(d.open).toFixed(2)}` : '',
                                d.high ? `High: \u20B9${parseFloat(d.high).toFixed(2)}` : '',
                                d.low ? `Low: \u20B9${parseFloat(d.low).toFixed(2)}` : '',
                                d.volume ? `Volume: ${formatNumberFull(d.volume)}` : ''
                            ].filter(Boolean);
                        }
                        return ctx.dataset.label + ': \u20B9' + ctx.parsed.y.toFixed(2);
                    }
                }
            };

            charts.stock = new Chart(ctx, { type: 'line', data: { labels: dates, datasets }, options: opts });
        }

        function renderSubscriberChart(data) {
            destroyChart('subscriber');
            if (!data.length) return;

            const ctx = document.getElementById('subscriberChart').getContext('2d');
            const dates = data.map(d => d.date);
            const subs = data.map(d => d.subscribers);

            const opts = baseChartOptions(v => formatNumber(v));
            opts.scales.y.beginAtZero = false;

            charts.subscriber = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Subscribers',
                        data: subs,
                        borderColor: COLORS.cyan.line,
                        backgroundColor: COLORS.cyan.fill,
                        borderWidth: 1.5, fill: true, tension: 0.3, pointRadius: 0, pointHoverRadius: 4
                    }]
                },
                options: opts
            });
        }

        function renderMonthlyChart(data) {
            destroyChart('monthly');
            if (!data.length) return;

            const ctx = document.getElementById('monthlyChart').getContext('2d');

            const monthlyData = {};
            data.forEach(item => {
                const month = item.date.substring(0, 7);
                if (!monthlyData[month]) monthlyData[month] = { views: 0, count: 0 };
                monthlyData[month].views += item.daily_views || 0;
                monthlyData[month].count++;
            });

            const months = Object.keys(monthlyData).sort();
            const monthlyViews = months.map(m => monthlyData[m].views);

            const opts = baseChartOptions();
            opts.plugins.tooltip = {
                callbacks: {
                    label: ctx => {
                        const m = months[ctx.dataIndex];
                        return [
                            `Total: ${formatNumberFull(ctx.parsed.y)}`,
                            `Days: ${monthlyData[m].count}`,
                            `Avg/Day: ${formatNumberFull(Math.round(ctx.parsed.y / monthlyData[m].count))}`
                        ];
                    }
                }
            };

            charts.monthly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Monthly Views',
                        data: monthlyViews,
                        backgroundColor: 'rgba(59,130,246,0.5)',
                        borderColor: COLORS.blue.line,
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: opts
            });
        }

        function renderCorrelationChart(youtubeData, stockData) {
            destroyChart('correlation');
            if (!youtubeData.length || !stockData.length) return;

            const ctx = document.getElementById('correlationChart').getContext('2d');

            const stockMap = {};
            stockData.forEach(s => { stockMap[s.date] = s; });

            const merged = [];
            youtubeData.forEach(yt => {
                const stock = stockMap[yt.date];
                if (stock) {
                    merged.push({ date: yt.date, views: yt.daily_views, price: parseFloat(stock.close) });
                }
            });

            if (!merged.length) return;

            const dates = merged.map(d => d.date);
            const views = merged.map(d => d.views);
            const prices = merged.map(d => d.price);

            let viewsData, pricesData, viewsLabel;
            const mode = chartStates.dualAxis;

            switch (mode) {
                case 'ma7':
                    viewsData = calculateMovingAverage(views, 7);
                    pricesData = prices;
                    viewsLabel = '7d MA Views';
                    break;
                case 'ma30':
                    viewsData = calculateMovingAverage(views, 30);
                    pricesData = prices;
                    viewsLabel = '30d MA Views';
                    break;
                case 'ma45':
                    viewsData = calculateMovingAverage(views, 45);
                    pricesData = prices;
                    viewsLabel = '45d MA Views';
                    break;
                case 'both':
                    viewsData = calculateMovingAverage(views, 45);
                    pricesData = calculateMovingAverage(prices, 45);
                    viewsLabel = '45d MA Views';
                    break;
                default:
                    viewsData = views;
                    pricesData = prices;
                    viewsLabel = 'Daily Views';
            }

            charts.correlation = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: viewsLabel,
                            data: viewsData,
                            borderColor: COLORS.blue.line,
                            backgroundColor: COLORS.blue.fill,
                            borderWidth: 1.5, fill: false, tension: 0.2, yAxisID: 'y', pointRadius: 0
                        },
                        {
                            label: mode === 'both' ? '45d MA Price' : 'Stock Price',
                            data: pricesData,
                            borderColor: COLORS.purple.line,
                            backgroundColor: COLORS.purple.fill,
                            borderWidth: 1.5, fill: false, tension: 0.2, yAxisID: 'y1', pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { display: true, position: 'top', labels: { boxWidth: 12, padding: 12 } } },
                    scales: {
                        y: {
                            type: 'linear', display: true, position: 'left',
                            title: { display: true, text: 'Views', color: COLORS.blue.line, font: { size: 11 } },
                            ticks: { callback: v => formatNumber(v), font: { size: 10 } },
                            grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--chart-grid').trim() }
                        },
                        y1: {
                            type: 'linear', display: true, position: 'right',
                            title: { display: true, text: 'Stock Price (\u20B9)', color: COLORS.purple.line, font: { size: 11 } },
                            ticks: { callback: v => '\u20B9' + v.toFixed(0), font: { size: 10 } },
                            grid: { drawOnChartArea: false }
                        },
                        x: { ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 12, font: { size: 10 } }, grid: { display: false } }
                    }
                }
            });
        }

        function renderVolumeChart(data) {
            destroyChart('volume');
            if (!data.length) return;

            const ctx = document.getElementById('volumeChart').getContext('2d');
            const dates = data.map(d => d.date);
            const volumes = data.map(d => d.volume || 0);
            const closes = data.map(d => parseFloat(d.close));

            // Color bars green/red based on price movement
            const bgColors = data.map((d, i) => {
                if (i === 0) return 'rgba(59,130,246,0.5)';
                return closes[i] >= closes[i - 1] ? 'rgba(16,185,129,0.5)' : 'rgba(239,68,68,0.5)';
            });

            const opts = baseChartOptions();
            charts.volume = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Volume',
                        data: volumes,
                        backgroundColor: bgColors,
                        borderWidth: 0,
                        borderRadius: 2
                    }]
                },
                options: opts
            });
        }

        function renderDistributionChart(data) {
            destroyChart('distribution');
            if (!data.length) return;

            const ctx = document.getElementById('distributionChart').getContext('2d');

            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayTotals = Array(7).fill(0);
            const dayCounts = Array(7).fill(0);

            data.forEach(item => {
                const d = new Date(item.date).getDay();
                dayTotals[d] += item.daily_views || 0;
                dayCounts[d]++;
            });

            const dayAvg = dayTotals.map((t, i) => dayCounts[i] > 0 ? Math.round(t / dayCounts[i]) : 0);

            const opts = baseChartOptions();
            opts.indexAxis = 'y';

            charts.distribution = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Avg Daily Views',
                        data: dayAvg,
                        backgroundColor: [
                            'rgba(239,68,68,0.5)',
                            'rgba(59,130,246,0.5)',
                            'rgba(6,182,212,0.5)',
                            'rgba(16,185,129,0.5)',
                            'rgba(245,158,11,0.5)',
                            'rgba(139,92,246,0.5)',
                            'rgba(236,72,153,0.5)'
                        ],
                        borderWidth: 0,
                        borderRadius: 4
                    }]
                },
                options: opts
            });
        }

        // ==========================================
        // CHART CONTROLS
        // ==========================================
        function toggleScale(chartName, scale, btn) {
            chartStates[chartName].scale = scale;
            const buttons = btn.parentElement.querySelectorAll('.chart-btn');
            buttons.forEach(b => { if (!b.textContent.trim().match(/^MA$/)) b.classList.remove('active'); });
            btn.classList.add('active');
            renderAllCharts();
        }

        function toggleMA(chartName, btn) {
            chartStates[chartName].showMA = !chartStates[chartName].showMA;
            btn.classList.toggle('active');
            renderAllCharts();
        }

        function toggleDualAxis(mode, btn) {
            chartStates.dualAxis = mode;
            const buttons = btn.parentElement.querySelectorAll('.chart-btn');
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderAllCharts();
        }

        // ==========================================
        // TABLE - ALL YOUTUBE DATA CAPTURED
        // ==========================================
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            const filteredData = filterDataByTimePeriod(allYoutubeData);

            if (!filteredData.length) {
                tbody.innerHTML = '<tr><td colspan="13" style="text-align:center;padding:30px;color:var(--text-muted)">No data available for this period</td></tr>';
                updatePagination(0);
                return;
            }

            const start = (currentPage - 1) * rowsPerPage;
            const end = Math.min(start + rowsPerPage, filteredData.length);
            const pageData = filteredData.slice(start, end);

            // Build stock lookup map for fast access
            const stockMap = {};
            allStockData.forEach(s => { stockMap[s.date] = s; });

            pageData.forEach((row, idx) => {
                const tr = document.createElement('tr');

                const globalIdx = filteredData.indexOf(row);
                const prevRow = globalIdx + 1 < filteredData.length ? filteredData[globalIdx + 1] : null;

                // View changes
                let viewChange = '--', viewChangePct = '--', viewClass = '';
                if (prevRow && prevRow.daily_views) {
                    const change = row.daily_views - prevRow.daily_views;
                    const pct = calculatePercentageChange(row.daily_views, prevRow.daily_views);
                    viewChange = (change > 0 ? '+' : '') + formatNumberFull(change);
                    viewChangePct = formatPercentage(pct);
                    viewClass = change >= 0 ? 'positive' : 'negative';
                }

                // Subscriber changes
                let subChange = '--', subClass = '';
                if (prevRow && prevRow.subscribers) {
                    const sc = row.subscribers - prevRow.subscribers;
                    subChange = (sc > 0 ? '+' : '') + formatNumberFull(sc);
                    subClass = sc >= 0 ? 'positive' : 'negative';
                }

                // Stock data
                const stock = stockMap[row.date];
                let stockClose = '--', stockOpen = '--', stockHigh = '--', stockLow = '--', stockVol = '--';
                let stockChangeStr = '--', stockClass = '';

                if (stock) {
                    stockClose = formatCurrency(stock.close);
                    stockOpen = stock.open ? formatCurrency(stock.open) : '--';
                    stockHigh = stock.high ? formatCurrency(stock.high) : '--';
                    stockLow = stock.low ? formatCurrency(stock.low) : '--';
                    stockVol = stock.volume ? formatNumberFull(stock.volume) : '--';

                    // Find prev stock
                    const stockIdx = allStockData.findIndex(s => s.date === stock.date);
                    const prevStock = stockIdx >= 0 && stockIdx < allStockData.length - 1 ? allStockData[stockIdx + 1] : null;

                    if (prevStock) {
                        const sc = stock.close - prevStock.close;
                        const scp = calculatePercentageChange(stock.close, prevStock.close);
                        stockChangeStr = `${sc > 0 ? '+' : ''}${formatCurrency(sc)} (${formatPercentage(scp)})`;
                        stockClass = sc >= 0 ? 'positive' : 'negative';
                    }
                }

                tr.innerHTML = `
                    <td>${row.date}</td>
                    <td>${formatNumberFull(row.daily_views)}</td>
                    <td class="${viewClass}">${viewChange}</td>
                    <td class="${viewClass}">${viewChangePct}</td>
                    <td>${formatNumberFull(row.subscribers)}</td>
                    <td class="${subClass}">${subChange}</td>
                    <td>${formatNumberFull(row.total_views)}</td>
                    <td>${stockClose}</td>
                    <td>${stockOpen}</td>
                    <td>${stockHigh}</td>
                    <td>${stockLow}</td>
                    <td>${stockVol}</td>
                    <td class="${stockClass}">${stockChangeStr}</td>
                `;
                tbody.appendChild(tr);
            });

            updatePagination(filteredData.length);
        }

        // ==========================================
        // PAGINATION
        // ==========================================
        function updatePagination(total) {
            const s = total === 0 ? 0 : (currentPage - 1) * rowsPerPage + 1;
            const e = Math.min(s + rowsPerPage - 1, total);
            document.getElementById('pageInfo').textContent = `Showing ${s}-${e} of ${total} records`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = e >= total;
        }

        function previousPage() {
            if (currentPage > 1) { currentPage--; renderTable(); }
        }

        function nextPage() {
            const total = filterDataByTimePeriod(allYoutubeData).length;
            if (currentPage < Math.ceil(total / rowsPerPage)) { currentPage++; renderTable(); }
        }

        // ==========================================
        // CSV EXPORT
        // ==========================================
        function exportCSV() {
            const filtered = filterDataByTimePeriod(allYoutubeData);
            if (!filtered.length) return;

            const stockMap = {};
            allStockData.forEach(s => { stockMap[s.date] = s; });

            const headers = ['Date', 'Daily Views', 'Subscribers', 'Total Views', 'Stock Close', 'Stock Open', 'Stock High', 'Stock Low', 'Stock Volume'];
            const rows = filtered.map(row => {
                const stock = stockMap[row.date] || {};
                return [row.date, row.daily_views, row.subscribers, row.total_views, stock.close || '', stock.open || '', stock.high || '', stock.low || '', stock.volume || ''];
            });

            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${COMPANY_CONFIG[currentCompany].name.replace(/\s+/g, '_')}_analytics_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ==========================================
        // INIT
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Dashboard initialized');
            fetchData();
        });
    </script>
</body>
</html>
